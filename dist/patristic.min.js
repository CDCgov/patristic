"use strict";function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||"[object Arguments]"===Object.prototype.toString.call(iter))return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(root,factory){"function"==typeof define&&define.amd?define([],function(){return root.patristic=factory()}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=factory():root.patristic=factory()}("undefined"!=typeof self?self:void 0,function(){function Branch(data){Object.assign(this,{id:"",parent:null,length:0,children:[]},data)}function search(t){for(var q,c2,qMin=1/0,D=t.D,n2=t.cN-2,S=t.S,I=t.I,rowSums=t.rowSums,removedColumns=t.removedIndices,uMax=t.rowSumMax,minI=-1,minJ=-1,r=0;r<t.N;r++)removedColumns.has(r)||(c2=I[r][0],removedColumns.has(c2)||(q=D[r][c2]*n2-rowSums[r]-rowSums[c2])<qMin&&(qMin=q,minI=r,minJ=c2));for(var _r=0;_r<t.N;_r++)if(!removedColumns.has(_r))for(var c=0;c<S[_r].length;c++)if(c2=I[_r][c],!removedColumns.has(c2)){if(S[_r][c]*n2-rowSums[_r]-uMax>qMin)break;(q=D[_r][c2]*n2-rowSums[_r]-rowSums[c2])<qMin&&(qMin=q,minI=_r,minJ=c2)}return{minI:minI,minJ:minJ}}function recalculateDistanceMatrix(t,joinedIndex1,joinedIndex2){var aux,aux2,D=t.D,n=D.length,sum=0,removedIndices=t.removedIndices,rowSums=t.rowSums,newRow=t.newRow,rowChange=t.rowChange,newMax=0;removedIndices.add(joinedIndex1);for(var i=0;i<n;i++)removedIndices.has(i)||(aux=D[joinedIndex1][i]+D[joinedIndex2][i],aux2=D[joinedIndex1][joinedIndex2],newRow[i]=.5*(aux-aux2),sum+=newRow[i],rowChange[i]=-.5*(aux+aux2));for(var _i3=0;_i3<n;_i3++)D[joinedIndex1][_i3]=-1,D[_i3][joinedIndex1]=-1,removedIndices.has(_i3)||(D[joinedIndex2][_i3]=newRow[_i3],D[_i3][joinedIndex2]=newRow[_i3],rowSums[_i3]+=rowChange[_i3],rowSums[_i3]>newMax&&(newMax=rowSums[_i3]));rowSums[joinedIndex1]=0,rowSums[joinedIndex2]=sum,sum>newMax&&(newMax=sum),t.rowSumMax=newMax,t.indicesLeft.delete(joinedIndex1)}function sortWithIndices(toSort,skip){void 0===skip&&(skip=-1);for(var n=toSort.length,indexCopy=new Array(n),valueCopy=new Array(n),i2=0,i=0;i<n;i++)-1!==toSort[i]&&i!==skip&&(indexCopy[i2]=i,valueCopy[i2++]=toSort[i]);indexCopy.length=i2,valueCopy.length=i2,indexCopy.sort(function(a,b){return toSort[a]-toSort[b]}),valueCopy.sortIndices=indexCopy;for(var j=0;j<i2;j++)valueCopy[j]=toSort[indexCopy[j]];return valueCopy}return Branch.prototype.addChild=function(data){var c;return data instanceof Branch?(c=data).parent=this:(data||(data={}),c=new Branch(Object.assign(data,{parent:this}))),this.children.push(c),c},Branch.prototype.addParent=function(data,siblings){var c;return data instanceof Branch?c=data:(data||(data={}),c=new Branch(Object.assign(data))),siblings.forEach(function(sib){return sib.setParent(c)}),c.children=[this].concat(siblings),this.parent=c,this},Branch.prototype.clone=function(){return patristic.parseJSON(this.toObject())},Branch.prototype.depthOf=function(descendant){var distance=0;if("string"==typeof descendant&&(descendant=this.getDescendant(descendant)),void 0===descendant)throw Error("Cannot compute depth of undefined descendant!");for(var current=descendant;!current.isRoot()&&current!==this;)distance+=current.length,current=current.parent;return distance},Branch.prototype.distanceTo=function(cousin){var mrca=this.getMRCA();return mrca.depthOf(this)+mrca.depthOf(cousin)},Branch.prototype.excise=function(){var _this=this;if(this.isRoot()&&this.children.length>1)throw new Error("Cannot excise a root node with multiple children.");return this.children.forEach(function(child){child.length+=_this.length,child.parent=_this.parent,_this.isRoot()||_this.parent.children.push(child)}),this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent},Branch.prototype.fixParenthood=function(nonrecursive){var _this2=this;return this.children.forEach(function(child){child.parent||(child.parent=_this2),child.parent!==_this2&&(child.parent=_this2),!nonrecursive&&child.children.length>0&&child.fixParenthood()}),this},Branch.prototype.getAncestors=function(){for(var ancestors=[],current=this;!current.isRoot();)ancestors.push(current.parent),current=current.parent;return ancestors},Branch.prototype.getChild=function(childID){if("string"==!_typeof(childID))throw Error("childID is not a String!");return this.children.find(function(c){return c.id===childID})},Branch.prototype.getDescendant=function(id){var descendant;if(this.children)for(var i=0;i<this.children.length;i++){var child=this.children[i];if(child.id===id){descendant=child;break}child.children&&(descendant=child.getDescendant(id))}return descendant},Branch.prototype.getDescendants=function(nonterminus){var descendants=nonterminus?[this]:[];return this.isLeaf()||this.children.forEach(function(child){child.getDescendants(!0).forEach(function(d){return descendants.push(d)})}),descendants},Branch.prototype.getLeafs=Branch.prototype.getLeaves,Branch.prototype.getLeaves=function(){if(this.isLeaf())return[this];var descendants=[];return this.children.forEach(function(child){child.getLeaves().forEach(function(d){return descendants.push(d)})}),descendants},Branch.prototype.getMRCA=function(cousin){for(var mrca=this;!mrca.hasDescendant(cousin);){if(mrca.isRoot())throw Error("Branch and cousin do not appear to share a common ancestor!");mrca=mrca.parent}return mrca},Branch.prototype.getRoot=function(){for(var node=this;!node.isRoot();)node=node.parent;return node},Branch.prototype.hasChild=function(child){if(child instanceof Branch)return this.children.includes(child);if("string"==typeof child)return this.children.some(function(c){return c.id===child});throw Error("Unknown type of child (".concat(_typeof(child),") passed to Branch.hasChild!"))},Branch.prototype.hasDescendant=function(descendant){var descendants=this.getDescendants();if(descendant instanceof Branch)return descendants.some(function(d){return d===descendant});if("string"==typeof descendant)return descendants.some(function(d){return d.id===descendant});throw Error("Unknown type of descendant passed to Branch.hasDescendant!")},Branch.prototype.hasLeaf=function(leaf){var leaves=this.getleaves();if(leaf instanceof Branch)return leaves.some(function(d){return d===leaf});if("string"==typeof leaf)return leaves.some(function(d){return d.id===leaf});throw Error("Unknown type of leaf passed to Branch.hasLeaf.")},Branch.prototype.invert=function(){var oldParent=this.parent;return oldParent&&(this.parent=oldParent.parent,this.children.push(oldParent),oldParent.parent=this,oldParent.children.splice(oldParent.children.indexOf(this),1)),this},Branch.prototype.isChildOf=function(parent){if(parent instanceof Branch)return this.parent===parent;if("string"==typeof parent)return this.parent.id===parent;throw Error("Unknown parent type passed to Branch.isChildOf")},Branch.prototype.isConsistent=function(){var _this3=this;return!(!this.isRoot()&&!this.parent.children.includes(this))&&(!!this.isLeaf()||!this.children.some(function(c){return c.parent!==_this3})&&this.children.every(function(c){return c.isConsistent()}))},Branch.prototype.isDescendantOf=function(ancestor){return!(!ancestor||!this.parent)&&(this.parent===ancestor||this.parent.id===ancestor||this.parent.isDescendantOf(ancestor))},Branch.prototype.isLeaf=function(){return 0===this.children.length},Branch.prototype.isolate=function(){var index=this.parent.children.indexOf(this);return this.parent.children.splice(index,1),this.setParent(null),this},Branch.prototype.isRoot=function(){return null===this.parent},Branch.prototype.remove=function(){var root=this.getRoot();return this.isolate(),root},Branch.prototype.reroot=function(){if(this.isRoot())return this;if(this.parent.isRoot()&&this.isLeaf())return this.parent;for(var newRoot=this.isLeaf()?this.parent:this,current=newRoot,toInvert=[];!current.isRoot();)toInvert.push(current),current=current.parent;return toInvert.reverse().forEach(function(c){return c.invert()}),newRoot},Branch.prototype.setLength=function(length){return this.length=length,this},Branch.prototype.setParent=function(parent){if(parent instanceof Branch||null===parent)return this.parent=parent,this;throw Error("Cannot set parent to non-Branch object!")},Branch.prototype.sources=function(cousin){var mrca=this.getMRCA(cousin);return mrca.depthOf(this)<mrca.depthOf(cousin)},Branch.prototype.targets=function(cousin){return cousin.sources(this)},Branch.prototype.toJSON=Branch.prototype.toObject,Branch.prototype.toMatrix=function(){for(var descendants=this.getLeaves(),n=descendants.length,matrix=new Array(n),i=0;i<n;i++){matrix[i]=new Array(n),matrix[i][i]=0;for(var j=0;j<i;j++){var distance=descendants[i].distanceTo(descendants[j]);matrix[i][j]=distance,matrix[j][i]=distance}}return{matrix:matrix,ids:descendants.map(function(d){return d.id})}},Branch.prototype.toNewick=function(nonterminus){var out="";return this.isLeaf()&&(out+="("+this.children.map(function(child){return child.toNewick(!0)}).join(",")+")"),out+=this.id,this.length&&(out+=":"+function(num){var numStr=String(num);if(Math.abs(num)<1){var e=parseInt(num.toString().split("e-")[1]);if(e){var negative=num<0;negative&&(num*=-1),num*=Math.pow(10,e-1),numStr="0."+new Array(e).join("0")+num.toString().substring(2),negative&&(numStr="-"+numStr)}}else{var _e=parseInt(num.toString().split("+")[1]);_e>20&&(_e-=20,num/=Math.pow(10,_e),numStr=num.toString()+new Array(_e+1).join("0"))}return numStr}(this.length)),nonterminus||(out+=";"),out},Branch.prototype.toObject=function(){var output={id:this.id,length:this.length};return this.children.length>0&&(output.children=this.children.map(function(c){return c.toObject()})),output},{version:"0.2.8",Branch:Branch,parseJSON:function(json,idLabel,lengthLabel,childrenLabel){idLabel||(idLabel="id"),lengthLabel||(lengthLabel="length"),childrenLabel||(childrenLabel="children"),"string"==typeof json&&(json=JSON.parse(json));var root=new Branch({id:json[idLabel],length:json[lengthLabel]});return json[childrenLabel]instanceof Array&&json[childrenLabel].forEach(function(child){root.addChild(patristic.parseJSON(child))}),root},parseMatrix:function(matrix,labels){var minI,minJ,d1,d2,l1,l2,node3,that={},N=that.N=matrix.length;labels||(labels=_toConsumableArray(Array(N).keys())),that.cN=that.N,that.D=matrix,that.labels=labels,that.labelToTaxon={},that.currIndexToLabel=new Array(N),that.rowChange=new Array(N),that.newRow=new Array(N),that.labelToNode=new Array(2*N),that.nextIndex=N,that.I=new Array(that.N),that.S=new Array(that.N);for(var i=0;i<that.N;i++){var sortedRow=sortWithIndices(that.D[i],i);that.S[i]=sortedRow,that.I[i]=sortedRow.sortIndices}that.removedIndices=new Set,that.indicesLeft=new Set;for(var _i=0;_i<N;_i++)that.currIndexToLabel[_i]=_i,that.indicesLeft.add(_i);function setUpNode(labelIndex,distance){var node;return labelIndex<that.N?(node=new Branch({id:that.labels[labelIndex],length:distance}),that.labelToNode[labelIndex]=node):(node=that.labelToNode[labelIndex]).setLength(distance),node}that.rowSumMax=0,that.PNewick="",that.rowSums=function(a){for(var n=a.length,sums=new Array(n),i=0;i<n;i++){for(var sum=0,j=0;j<n;j++){var v=parseFloat(a[i][j]);"number"==typeof v&&(sum+=a[i][j])}sums[i]=sum}return sums}(that.D);for(var _i2=0;_i2<that.cN;_i2++)that.rowSums[_i2]>that.rowSumMax&&(that.rowSumMax=that.rowSums[_i2]);for(;that.cN>2;){var _search=search(that);minI=_search.minI,minJ=_search.minJ,d1=.5*that.D[minI][minJ]+(that.rowSums[minI]-that.rowSums[minJ])/(2*that.cN-4),d2=that.D[minI][minJ]-d1,l1=that.currIndexToLabel[minI],l2=that.currIndexToLabel[minJ],node3=new Branch({children:[setUpNode(l1,d1),setUpNode(l2,d2)]}),recalculateDistanceMatrix(that,minI,minJ);var sorted=sortWithIndices(that.D[minJ],minJ);that.S[minJ]=sorted,that.I[minJ]=sorted.sortIndices,that.S[minI]=that.I[minI]=[],that.cN--,that.labelToNode[that.nextIndex]=node3,that.currIndexToLabel[minI]=-1,that.currIndexToLabel[minJ]=that.nextIndex++}var left=that.indicesLeft.values();minI=left.next().value,minJ=left.next().value,l1=that.currIndexToLabel[minI],l2=that.currIndexToLabel[minJ];var tree=new Branch({children:[setUpNode(l1,d1=d2=that.D[minI][minJ]/2),setUpNode(l2,d2)]});return tree.fixParenthood(),tree},parseNewick:function(newick){for(var ancestors=[],tree=new Branch,tokens=newick.split(/\s*(;|\(|\)|,|:)\s*/),n=tokens.length,t=0;t<n;t++){var token=tokens[t],c=void 0;switch(token){case"(":c=tree.addChild(),ancestors.push(tree),tree=c;break;case",":tree=c=ancestors[ancestors.length-1].addChild();break;case")":tree=ancestors.pop();break;case":":break;default:var x=tokens[t-1];")"==x||"("==x||","==x?tree.id=token:":"==x&&(tree.length=parseFloat(token))}}return tree}}});
